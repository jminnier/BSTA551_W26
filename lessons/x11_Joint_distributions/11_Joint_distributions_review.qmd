---
title: "Lesson 11: Joint distributions"
author: "Meike Niederhausen and Nicky Wakim"
date: "`r library(here); source(here('class_dates.R')); w5d2`"
title-slide-attributes:
    data-background-color: "#006a4e"
format: 
  html:
    theme: "../simple_NW.scss"
    slide-number: true
    show-slide-number: all
    width: 1955
    height: 1100
    page-layout: full
    footer: Lesson 11 Slides
    html-math-method: mathjax
---

```{r setup, include=FALSE}


library(here)
source(here("class_dates.R"))

library(tidyverse)
```

## Recall: Finding the pdf of a transformation

-   Let $M$ be a transformation of $X$ and $Y$: $M = g(X, Y)$

-   When we have a transformation of $X$ and $Y$, $M$, we need to follow the **CDF method** to find the pdf of $M$

We follow **CDF method**:

1.  Start with the joint pdf for $X$ and $Y$

    -   aka $f_{X,Y}(x, y)$

2.  Translate the domain of $X$ and $Y$ to $M$: find possible values of $M$

3.  Find the CDF of $M$

    - aka $F_M(m) = P(M \leq m) = P(g(X, Y) \leq m)$

4.  Take the derivative of the CDF of $M$ with respect to $m$ to find the pdf of $M$ 

    -   aka $f_M(m) = \dfrac{d}{dm}F_M(m)$

## Example of a joint pdf with a transformation (1/3)

::::::: columns
:::::: {.column width="30%"}
::::: example
::: ex-title
Example 4.1
:::

::: ex-cont
Let $X$ and $Y$ have constant density on the square $0 \leq X \leq 4, 0 \leq Y \leq 4$.

1.  Find $\mathbb{P}(|X-Y| < 2)$
:::
:::::

```{r}
#| fig-width: 6
#| fig-height: 5.5
#| echo: false

library(tidyverse)
joint2 = tibble(
  x = seq(0, 4, 0.5), 
  y = seq(0, 4, 0.5)
)

x_y_plot2 = ggplot(joint2, aes(x = x, y = y)) +
  labs(x = "x", y = "y") +
  scale_x_continuous(breaks = c(0, 2, 4)) +
  scale_y_continuous(breaks = c(0, 2, 4)) +
  theme_bw() +
  theme(text = element_text(size=30))
x_y_plot2
```

::::::
:::::::

## Example of a joint pdf with a transformation (2/3)

::::: example
::: ex-title
Example 4.2
:::

::: ex-cont
Let $X$ and $Y$ have constant density on the square $0 \leq X \leq 4, 0 \leq Y \leq 4$.

2.  Let $M = \max(X,Y)$. Find the pdf for $M$, that is $f_M(m)$
:::
:::::

```{r}
#| fig-width: 6
#| fig-height: 5.5
#| echo: false


x_y_plot2
```

$$
f_{X,Y}(x,y) = \dfrac{1}{16} \text{ for } 0 \leq x \leq 4, 0 \leq y \leq 4
$$

Plot of $f_{X,Y}(x,y)$:

```{r}
#| warning: false
#| fig-width: 6
#| fig-height: 8
#| echo: false

library(tidyverse)
library(plotly)

x = seq(0, 4, 0.1)
y = seq(0, 4, 0.1)
fn = expand.grid(x=x,y=y)
fn$z = 1/16

z = matrix(fn$z, ncol = 51, nrow = 51, byrow = T)

fig <- plot_ly(x = x, y=y, z=z) %>% add_surface()

fig
```

For first problem, we want: 

```{r}
#| warning: false
#| fig-width: 6
#| fig-height: 8
#| echo: false

library(plotly)

# grid
x <- seq(0, 4, length.out = 81)
y <- seq(0, 4, length.out = 81)
grid <- expand.grid(x=x, y=y)
z_val <- 1/16
# indicator for the event
grid$z <- ifelse(abs(grid$x - grid$y) < 2, z_val, 0)

# reshape to matrix for plotly (rows = length(y), cols = length(x) typically)
z_mat <- matrix(grid$z, nrow = length(x), ncol = length(y), byrow = FALSE)

fig <- plot_ly(x = ~x, y = ~y, z = ~z_mat) %>%
  add_surface(
    showscale = FALSE,
    contours = list(
      z = list(show=TRUE, usecolormap=TRUE, highlightcolor="#ff0000", project=list(z=TRUE))
    ),
    lighting = list(ambient=0.8, diffuse=0.8, specular=0.2),
    hoverinfo = "x+y+z"
  ) %>%
  layout(
    title = "Volume for event |X - Y| < 2 (height = 1/16)",
    scene = list(
      xaxis = list(title = "x", range = c(0,4)),
      yaxis = list(title = "y", range = c(0,4)),
      zaxis = list(title = "density f(x,y)", range = c(0, 0.08)),
      aspectratio = list(x=1, y=1, z=0.3),
      camera = list(eye = list(x = 1.5, y = 1.5, z = 0.8))
    )
  )

fig

```

Now I want to show the domain for the max, M:

```{r}
#| warning: false
#| fig-width: 6
#| fig-height: 8
#| echo: false

library(tidyverse)
library(plotly)

x = seq(0, 4, 0.1)
y = seq(0, 4, 0.1)
fn = expand.grid(x=x,y=y)
fn = fn %>% rowwise() %>%
  mutate(m = max(x, y))

m = matrix(fn$m, ncol = 41, nrow = 41, byrow = T)

fig <- plot_ly(x = x, y=y, z=m) %>% add_surface()

fig
```


## Example of a joint pdf with a transformation (3/3)

::::::: columns
:::::: {.column width="30%"}
::::: example
::: ex-title
Example 4.3
:::

::: ex-cont
Let $X$ and $Y$ have constant density on the square $0 \leq X \leq 4, 0 \leq Y \leq 4$.

3.  Let $Z = \min(X,Y)$. Find the pdf for $Z$, that is $f_Z(z)$.
:::
:::::

```{r}
#| fig-width: 6
#| fig-height: 5.5
#| echo: false

x_y_plot2
```

::::::

:::::: {.column width="70%"}

::::::
:::::::

## Last example *for home*: more complicated transformation

::::::: columns
:::::: {.column width="30%"}
::::: example
::: ex-title
Example 5
:::

::: ex-cont
Let $X$ and $Y$ have joint density $f_{X,Y}(x,y)= \frac85(x+y)$ in the region $0 < x < 1,\ \frac12 < y <1$. Find the pdf of the RV $Z$, where $Z=XY$.
:::
:::::

```{r}
#| fig-width: 6
#| fig-height: 5.5
#| echo: false

joint3 = tibble(
  x = seq(0, 1, 0.5), 
  y = seq(0, 1, 0.5)
)

x_y_plot3 = ggplot(joint3, aes(x = x, y = y)) +
  labs(x = "x", y = "y") +
  scale_x_continuous(breaks = c(0, 0.5, 1)) +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  theme_bw() +
  theme(text = element_text(size=30))
x_y_plot3
```

::::::
:::::::

We can look at the joint pdf of X and Y:

```{r}
#| warning: false
#| fig-width: 6
#| fig-height: 8
#| echo: false

library(tidyverse)
library(plotly)

x = seq(0, 1, 0.01)
y = seq(0.5, 1, 0.01/2)
fn = expand.grid(x=x,y=y)
fn = fn %>% rowwise() %>%
  mutate(z = (8/5)*(x+y))

z = matrix(fn$z, ncol = 101, nrow = 101, byrow = T)

fig <- plot_ly(x = x, y=y, z=z) %>% add_surface()

fig
```

And let's look at $P(Z \leq 0.5)$ aka $P(XY \leq 0.5)$ to get a better sense of the volume needed: 

```{r}
#| warning: false
#| fig-width: 6
#| fig-height: 7
#| echo: false

library(plotly)
library(dplyr)

# Define the joint support
x <- seq(0, 1, length.out = 200)
y <- seq(0.5, 1, length.out = 200)
grid <- expand.grid(x = x, y = y)

# Joint pdf
grid <- grid %>%
  mutate(
    f = (8/5)*(x + y),
    Z = x*y,
    region = ifelse(Z <= 0.5, TRUE, FALSE)
  )

# Convert to matrix form
z_mat <- matrix(grid$f, nrow = length(x), ncol = length(y), byrow = FALSE)

# Create a mask for the region Z <= 0.5
z_mask <- matrix(ifelse(grid$region, grid$f, NA), 
                 nrow = length(x), ncol = length(y), byrow = FALSE)

# Base pdf surface
fig <- plot_ly(showscale = FALSE) %>%
  add_surface(
    x = ~x, y = ~y, z = ~z_mat,
    colorscale = list(c(0, 1), c("lightgray", "lightgray")),
    opacity = 0.6,
    name = "Joint PDF f(x,y)"
  ) %>%
  # Shaded region for P(Z ≤ 0.5)
  add_surface(
    x = ~x, y = ~y, z = ~z_mask,
    colorscale = list(c(0, 1), c("skyblue", "royalblue")),
    opacity = 0.9,
    name = "Region: Z = XY ≤ 0.5"
  ) %>%
  layout(
    title = "Volume for P(Z ≤ 0.5), where Z = XY",
    scene = list(
      xaxis = list(title = "X", range = c(0, 1)),
      yaxis = list(title = "Y", range = c(0.5, 1)),
      zaxis = list(title = "f(x,y)", range = c(0, 3.2)),
      aspectratio = list(x=1, y=1, z=0.7),
      camera = list(eye = list(x = 1.6, y = 1.6, z = 1.1))
    )
  )

fig

```

Now I want to show the domain for Z:

```{r}
#| warning: false
#| fig-width: 6
#| fig-height: 8
#| echo: false

library(tidyverse)
library(plotly)

x = seq(0, 1, 0.01)
y = seq(0.5, 1, 0.01/2)
fn = expand.grid(x=x,y=y)
fn = fn %>% rowwise() %>%
  mutate(z = x*y)

z = matrix(fn$z, ncol = 101, nrow = 101, byrow = T)

fig <- plot_ly(x = x, y=y, z=z) %>% add_surface()

fig
```

Now I want to show the domain for Z:

```{r}
#| warning: false
#| fig-width: 8
#| fig-height: 6
#| echo: false

joint3 = expand.grid(  x = seq(0, 1, 0.01),
  z = seq(0, 1, 0.125)) %>%
  mutate(y = z/x) %>%
  filter( y <= 1 & y >= 0.5) %>%
  mutate(z = as.factor(z))

x_y_plot3 = ggplot(joint3, aes(x = x, y = y)) +
  geom_point(aes(x = x, y = y, colour = z)) +
  labs(x = "x", y = "y") +
  scale_x_continuous(breaks = c(0, 0.5, 1)) +
  scale_y_continuous(breaks = c(0.5, 0.75, 1)) +
  theme_bw() +
  theme(text = element_text(size=30))
x_y_plot3
```